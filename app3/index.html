<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Scheduler & Seating Planner</title>
    <style>
        :root {
            --primary: #4F46E5; --primary-hover: #4338ca;
            --surface: #ffffff; --background: #f3f4f6;
            --text-main: #111827; --text-muted: #6b7280;
            --border: #e5e7eb; --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --success: #10b981;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { background-color: var(--background); color: var(--text-main); min-height: 100vh; padding: 2rem 1rem; }
        
        .container { max-width: 1400px; margin: 0 auto; }
        .hidden { display: none !important; }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        h1 { font-size: 2rem; color: var(--primary); }
        .btn-nav { background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; text-decoration: none; font-weight: 600; }
        .btn-nav:hover { background: #eef2ff; }

        .card { background: var(--surface); padding: 2rem; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 2rem; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-main); }
        input[type="date"], input[type="number"] { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; }
        
        .file-upload { border: 2px dashed var(--border); padding: 2rem; text-align: center; border-radius: 8px; cursor: pointer; transition: 0.2s; background: #fafafa; }
        .file-upload:hover { border-color: var(--primary); background: #eef2ff; }
        .file-list { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem; }
        
        .btn { padding: 0.75rem 1.5rem; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; font-size: 1rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-main); }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: var(--surface); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border); text-align: center; }
        .stat-val { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .stat-label { font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; }

        .table-wrapper { overflow-x: auto; background: var(--surface); border-radius: 8px; box-shadow: var(--shadow); }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: #f9fafb; font-weight: 600; position: sticky; top: 0; }
        td input { width: 100%; border: 1px solid transparent; padding: 4px; border-radius: 4px; background: transparent; }
        td input:focus { border-color: var(--primary); background: white; outline: none; }
        
        /* Seating Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal { background: white; width: 90%; max-width: 1000px; max-height: 90vh; overflow-y: auto; padding: 2rem; border-radius: var(--radius); position: relative; }
        .modal-close { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); }
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .facing-toggle select { padding: 5px 10px; border-radius: 4px; border: 1px solid var(--border); }

        .seating-stage { background: #374151; padding: 2rem; border-radius: 8px; color: white; display: flex; flex-direction: column; align-items: center; margin-bottom: 1rem; position: relative; }
        .blackboard { width: 70%; height: 24px; background: #1f2937; border-bottom: 4px solid #d1d5db; margin-bottom: 2rem; text-align: center; line-height: 24px; font-size: 0.8rem; letter-spacing: 2px; border-radius: 4px; position: relative; z-index: 10;}
        
        .direction-indicator { position: absolute; font-size: 0.7rem; background: #4b5563; padding: 2px 6px; border-radius: 4px; color: white; }
        .dir-left { left: 5px; top: 50%; transform: translateY(-50%); }
        .dir-right { right: 5px; top: 50%; transform: translateY(-50%); }

        .seating-grid { display: grid; gap: 4px; margin: 0 auto; }
        .seat { display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold; border-radius: 4px; position: relative; transition: transform 0.2s; }
        .seat:hover { transform: scale(1.05); z-index: 5; }
        
        /* Individual Chairs */
        .seat-desk { width: 40px; height: 40px; background: #e5e7eb; color: #374151; border: 1px solid #d1d5db; box-shadow: 1px 1px 3px rgba(0,0,0,0.2); }
        
        /* Benches */
        .seat-bench { width: 100px; height: 35px; background: #93c5fd; color: #1e3a8a; border: 1px solid #60a5fa; display: flex; justify-content: space-around; align-items: center; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); }

        /* Group Colors */
        .group-span { padding: 0 4px; border-radius: 3px; }
        .group-A { background-color: #fee2e2; color: #991b1b; } 
        .group-B { background-color: #d1fae5; color: #065f46; } 
        .group-C { background-color: #fef3c7; color: #92400e; } 
        .group-D { background-color: #e0e7ff; color: #3730a3; } 

        .toast { position: fixed; bottom: 2rem; right: 2rem; background: #333; color: white; padding: 1rem 2rem; border-radius: 8px; z-index: 2000; transform: translateY(150%); transition: transform 0.3s; }
        .toast.show { transform: translateY(0); }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>üéì Exam Scheduler</h1>
        <nav>
            <button id="nav-home" class="btn-nav hidden" onclick="showSection('home')">New Schedule</button>
        </nav>
    </header>

    <!-- SECTION 1: GENERATOR -->
    <main id="section-home">
        <div class="card">
            <h2>Generate Schedule</h2>
            <form id="scheduleForm">
                <div class="form-grid">
                    <div>
                        <label>Start Date</label>
                        <input type="date" id="start_date" name="start_date" required>
                    </div>
                    <div>
                        <label>Courses per Room</label>
                        <input type="number" id="courses_per_room" name="courses_per_room" value="2" min="1" max="10" required>
                    </div>
                </div>

                <div class="file-list">
                    <div class="file-upload" onclick="document.getElementById('courses').click()">
                        <div>üìÅ Courses (Excel)</div>
                        <small id="name-courses" class="text-muted">No file selected</small>
                        <input type="file" id="courses" name="courses" accept=".xlsx, .xls" class="hidden" required onchange="updateName(this)">
                    </div>
                    <div class="file-upload" onclick="document.getElementById('rooms').click()">
                        <div>üö™ Rooms (Excel)</div>
                        <small id="name-rooms" class="text-muted">No file selected</small>
                        <input type="file" id="rooms" name="rooms" accept=".xlsx, .xls" class="hidden" required onchange="updateName(this)">
                    </div>
                    <div class="file-upload" onclick="document.getElementById('faculty').click()">
                        <div>üë®‚Äçüè´ Faculty (CSV)</div>
                        <small id="name-faculty" class="text-muted">No file selected</small>
                        <input type="file" id="faculty" name="faculty" accept=".csv" class="hidden" required onchange="updateName(this)">
                    </div>
                </div>

                <div style="margin-top: 2rem; text-align: right;">
                    <button type="submit" class="btn btn-primary" id="generateBtn">
                        <span>Generate Timetable</span>
                    </button>
                </div>
            </form>
        </div>
    </main>

    <!-- SECTION 2: VIEW & EDIT -->
    <main id="section-view" class="hidden">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-val" id="stat-courses">0</div>
                <div class="stat-label">Courses Scheduled</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="stat-students">0</div>
                <div class="stat-label">Students Assigned</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="stat-status" style="font-size: 1rem; line-height: 2.5rem;">Checking...</div>
                <div class="stat-label">Status</div>
            </div>
        </div>

        <div style="display: flex; gap: 1rem; margin-bottom: 1rem; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="downloadExcel()">Download Excel</button>
            <button class="btn btn-primary" onclick="saveChanges()">Save Changes</button>
        </div>

        <div class="table-wrapper">
            <table id="scheduleTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Slot</th>
                        <th>Room (Capacity)</th>
                        <th>Faculty</th>
                        <th>Course</th>
                        <th>Year</th>
                        <th>Students</th>
                        <th>Roll Numbers</th>
                        <th>Seating</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows injected via JS -->
                </tbody>
            </table>
        </div>
    </main>
</div>

<!-- SEATING MODAL -->
<div class="modal-overlay" id="seatingModal">
    <div class="modal">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        
        <div class="modal-header">
            <div>
                <h2 id="modalTitle">Room Layout</h2>
                <p id="modalSubtitle" style="color: #6b7280; margin-bottom: 0;"></p>
            </div>
            <div class="facing-toggle">
                <label style="font-size:0.8rem;">View Facing:</label>
                <select id="facingSelect" onchange="updateFacing()">
                    <option value="E">East Facing</option>
                    <option value="W">West Facing</option>
                </select>
            </div>
        </div>
        
        <div class="seating-stage" id="stageArea">
            <div class="direction-indicator dir-left" id="dirLeft">WINDOW</div>
            <div class="direction-indicator dir-right" id="dirRight">DOOR</div>
            <div class="blackboard">FRONT (BLACKBOARD)</div>
            <div id="seatingGrid" class="seating-grid"></div>
        </div>
        
        <div style="text-align: center; margin-top: 1rem; font-size: 0.9rem; color: #374151;" id="modalLegend">
            <!-- Legend injected here -->
        </div>
    </div>
</div>

<div id="toast" class="toast">Action Successful</div>

<script>
    const state = {
        schedule: [],
        config: {},
        verification: {},
        currentLayout: null
    };

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('start_date').valueAsDate = new Date();
    });

    function updateName(input) {
        document.getElementById(`name-${input.id}`).textContent = input.files[0].name;
    }

    function showToast(msg, type = 'success') {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.style.background = type === 'error' ? '#ef4444' : '#10b981';
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    function showSection(section) {
        document.getElementById('section-home').classList.add('hidden');
        document.getElementById('section-view').classList.add('hidden');
        document.getElementById('nav-home').classList.add('hidden');

        if (section === 'home') {
            document.getElementById('section-home').classList.remove('hidden');
        } else {
            document.getElementById('section-view').classList.remove('hidden');
            document.getElementById('nav-home').classList.remove('hidden');
            loadSchedule();
        }
    }

    document.getElementById('scheduleForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('generateBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = 'Processing...';
        btn.disabled = true;

        const formData = new FormData(e.target);

        try {
            const res = await fetch('/generate', { method: 'POST', body: formData });
            const data = await res.json();

            if (res.ok) {
                showToast(data.message);
                showSection('view');
            } else {
                showToast(data.error, 'error');
            }
        } catch (err) {
            showToast('Network error', 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    });

    async function loadSchedule() {
        try {
            const res = await fetch('/view');
            if (!res.ok) throw new Error('Failed to load');
            const data = await res.json();
            
            state.schedule = data.schedule;
            state.config = data.config;
            state.verification = data.verification;

            renderDashboard();
            renderTable();
        } catch (err) {
            showToast(err.message, 'error');
            showSection('home');
        }
    }

    function renderDashboard() {
        document.getElementById('stat-courses').textContent = state.verification.scheduled_courses;
        document.getElementById('stat-students').textContent = state.verification.scheduled_students;
        
        const statusEl = document.getElementById('stat-status');
        statusEl.textContent = state.verification.status;
        statusEl.style.color = state.verification.status === 'Success' ? 'var(--success)' : '#f59e0b';
    }

    function renderTable() {
        const tbody = document.querySelector('#scheduleTable tbody');
        tbody.innerHTML = '';
        
        state.schedule.forEach((row, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="date" value="${row.Date}" onchange="updateData(${idx}, 'Date', this.value)"></td>
                <td><input type="text" value="${row.Slot}" onchange="updateData(${idx}, 'Slot', this.value)"></td>
                <td>
                    <input type="text" value="${row.Room}" readonly style="background:#f3f4f6; font-weight:600;">
                    <div style="font-size:0.7rem; color:#6b7280;">Cap: ${row.RoomCapacity}</div>
                </td>
                <td><input type="text" value="${row.Faculty}" onchange="updateData(${idx}, 'Faculty', this.value)"></td>
                <td><input type="text" value="${row.Course}" onchange="updateData(${idx}, 'Course', this.value)"></td>
                <td><input type="text" value="${row.Year}" onchange="updateData(${idx}, 'Year', this.value)"></td>
                <td><input type="number" value="${row['Student Count']}" readonly style="width: 60px; background:#f3f4f6;"></td>
                <td><input type="text" value="${row['Roll Numbers']}" style="font-size:0.8em;" oninput="updateCount(this, ${idx})"></td>
                <td>
                    <button class="btn-secondary" style="padding: 4px 8px; font-size: 0.8rem;" onclick="openSeating(${idx})">
                        ü™ë Layout
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updateData(idx, field, val) {
        state.schedule[idx][field] = val;
    }

    function updateCount(input, idx) {
        const rolls = input.value;
        const count = rolls.trim() === '' ? 0 : rolls.split(',').length;
        state.schedule[idx]['Student Count'] = count;
        input.parentElement.previousElementSibling.querySelector('input').value = count;
    }

    async function saveChanges() {
        try {
            const res = await fetch('/save_changes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ rows: state.schedule })
            });
            const data = await res.json();
            if (data.success) showToast('Saved successfully!');
            else showToast(data.error, 'error');
        } catch (err) {
            showToast('Error saving', 'error');
        }
    }

    function downloadExcel() {
        if (state.config.schedule_file) {
            window.location.href = `/uploads/${state.config.schedule_file}`;
        }
    }

    async function openSeating(idx) {
        const row = state.schedule[idx];
        const cap = row.RoomCapacity;
        const groups = state.config.courses_per_room || 2;
        const roomName = row.BaseRoom; 

        document.getElementById('modalTitle').textContent = `Seating: ${row.Room}`;
        document.getElementById('modalSubtitle').textContent = `Capacity: ${cap} | Groups: ${groups}`;

        try {
            const res = await fetch('/api/seating', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ capacity: cap, groups: groups, room_name: roomName })
            });
            const layout = await res.json();
            state.currentLayout = layout;
            
            renderGrid(layout);
            updateFacing();
            
            document.getElementById('seatingModal').classList.add('open');
        } catch (err) {
            showToast('Failed to generate layout', 'error');
        }
    }

    function updateFacing() {
        const facing = document.getElementById('facingSelect').value;
        const left = document.getElementById('dirLeft');
        const right = document.getElementById('dirRight');

        if (facing === 'E') {
            left.textContent = "WINDOW"; right.textContent = "DOOR";
        } else {
            left.textContent = "DOOR"; right.textContent = "WINDOW";
        }
    }

    function renderGrid(layout) {
        const container = document.getElementById('seatingGrid');
        container.innerHTML = '';
        container.style.gridTemplateColumns = `repeat(${layout.cols}, 1fr)`;

        const isBench = layout.type === 'bench';

        layout.grid.forEach(row => {
            row.forEach(cellData => {
                const div = document.createElement('div');
                
                if (isBench) {
                    div.className = 'seat seat-bench';
                } else {
                    div.className = 'seat seat-desk';
                }

                // Split "A1 B1" or just "A1" into spans
                const parts = cellData.trim().split(/\s+/);
                
                const htmlContent = parts.map(part => {
                    const groupChar = part.charAt(0); // Extract 'A'
                    return `<span class="group-span group-${groupChar}">${part}</span>`;
                }).join('');

                div.innerHTML = htmlContent;
                container.appendChild(div);
            });
        });

        document.getElementById('modalLegend').innerHTML = `
            Grid: ${layout.rows} Rows x ${layout.cols} Cols<br>
            Layout Type: ${layout.type.toUpperCase()}<br>
            ${isBench ? "Bench Mode: Groups stacked per bench." : "Individual Mode: Groups alternate per chair."}
        `;
    }

    function closeModal() {
        document.getElementById('seatingModal').classList.remove('open');
    }

    document.getElementById('seatingModal').addEventListener('click', (e) => {
        if (e.target.id === 'seatingModal') closeModal();
    });

</script>
</body>
</html>